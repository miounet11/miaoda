# MiaoDa Chat 智能摘要功能使用指南

## 功能概述

智能摘要功能通过AI自动分析对话内容，生成简洁的对话摘要、提取关键要点并自动标记主题标签，帮助用户快速了解对话内容和查找历史对话。

## 主要特性

### 1. 自动会话摘要生成
- **触发条件**: 当对话消息数量达到3条或以上时
- **生成时机**: 
  - 新消息添加后自动检查是否需要生成摘要
  - 对话达到5条消息时自动生成
  - 摘要超过24小时且有新消息时自动更新
- **摘要内容**: 200字以内的简洁总结

### 2. 智能主题标签系统
- **自动标签**: AI自动识别对话主题并生成3-8个相关标签
- **标签分类**: 
  - 热门标签：使用频率最高的标签
  - 最近标签：最近使用的标签
- **手动编辑**: 支持用户手动添加、修改或删除标签

### 3. 关键要点提取
- **要点数量**: 每个对话提取3-5个关键要点
- **内容识别**: 自动识别对话中的重要信息点
- **结构化显示**: 以列表形式清晰展示

## 界面说明

### 聊天视图中的摘要显示
1. **位置**: 聊天头部下方，消息列表上方
2. **展示模式**:
   - **折叠状态**: 显示摘要和前3个标签
   - **展开状态**: 显示完整摘要、所有标签和关键要点

### 侧边栏中的摘要预览
1. **聊天列表**: 每个对话项显示摘要预览和主要标签
2. **标签云**: 顶部显示所有可用标签，支持筛选功能

### 摘要组件操作
- **✨ 生成摘要**: 手动触发摘要生成
- **✏️ 编辑摘要**: 修改摘要内容、标签和要点
- **❌ 清除摘要**: 删除现有摘要
- **🔽/🔼 展开/收起**: 切换详细显示模式

## 使用方法

### 自动生成摘要
1. 正常进行对话，当消息达到3条以上时，摘要区域会自动显示
2. 系统会在合适的时机自动生成摘要（通常是5条消息后）
3. 摘要生成过程中会显示加载动画

### 手动生成摘要
1. 点击摘要区域的"生成摘要"按钮（✨图标）
2. 等待AI分析对话内容并生成摘要
3. 摘要生成后会自动展开显示详细内容

### 编辑摘要内容
1. 点击摘要右上角的编辑按钮（✏️图标）
2. 在弹出的编辑对话框中修改：
   - **摘要文本**: 直接编辑摘要内容
   - **标签**: 用逗号分隔多个标签
   - **关键要点**: 每行一个要点
3. 点击"保存"按钮确认修改

### 使用标签筛选对话
1. 在侧边栏顶部的标签云中点击感兴趣的标签
2. 系统会筛选包含该标签的对话
3. 可以选择多个标签进行组合筛选
4. 点击"Clear"清除所有筛选条件

### 搜索对话内容
1. 点击摘要中的任意标签可快速搜索相关对话
2. 在搜索框中输入标签名称进行模糊匹配
3. 支持按主题快速定位历史对话

## 技术实现

### 前端架构
```
src/renderer/src/
├── components/chat/
│   ├── ChatSummary.vue          # 摘要显示组件
│   ├── TagCloud.vue             # 标签云组件
│   └── ChatSidebar.vue          # 集成摘要预览的侧边栏
├── services/summary/
│   └── SummaryService.ts        # 摘要服务逻辑
└── types/chat.ts                # 摘要相关类型定义
```

### 后端架构
```
src/main/
├── db/
│   ├── SummaryService.ts        # 摘要数据库操作
│   ├── database.ts              # 数据库主类
│   └── types.ts                 # 数据库类型定义
└── ipcHandlers.ts               # IPC通信处理
```

### 数据存储
- **数据库表**: 在 `chats` 表中新增摘要相关字段
- **字段说明**:
  - `summary`: 摘要文本
  - `summary_tags`: JSON格式的标签数组
  - `summary_updated_at`: 摘要更新时间
  - `summary_tokens`: 摘要消耗的token数量
  - `key_points`: JSON格式的关键要点数组

## API接口

### 前端API调用
```typescript
// 获取摘要
const summary = await SummaryService.getInstance().getChatSummary(chatId)

// 生成摘要
const summary = await SummaryService.getInstance().generateSummary(
  chatId, 
  messages, 
  {
    maxLength: 200,
    includeKeyPoints: true,
    includeTags: true,
    language: 'zh-CN'
  }
)

// 更新摘要
await SummaryService.getInstance().updateSummary(chatId, {
  summary: 'Updated summary',
  tags: ['tag1', 'tag2'],
  keyPoints: ['point1', 'point2']
})
```

### IPC通信接口
```typescript
// 数据库操作
window.api.db.updateChatSummary(chatId, summary, tags, keyPoints, tokens)
window.api.db.getChatSummary(chatId)
window.api.db.getAllSummaryTags()
window.api.db.searchChatsByTags(tags)

// LLM摘要生成
window.api.llm.generateSummary(prompt)
```

## 配置选项

### 摘要生成参数
- **maxLength**: 摘要最大长度（默认200字符）
- **includeKeyPoints**: 是否包含关键要点（默认true）
- **includeTags**: 是否包含标签（默认true）
- **language**: 语言设置（默认zh-CN）

### 自动生成触发条件
- **minMessages**: 最小消息数量（默认5条）
- **maxAgeHours**: 摘要最大有效期（默认24小时）

## 性能优化

### 缓存机制
- 摘要数据本地缓存，避免重复生成
- 标签列表缓存，提高筛选响应速度

### 异步处理
- 摘要生成使用异步处理，不阻塞界面操作
- 支持生成过程中的取消操作

### 资源控制
- 限制摘要生成的token使用量
- 智能判断是否需要更新摘要，避免不必要的API调用

## 故障排除

### 常见问题
1. **摘要生成失败**
   - 检查LLM服务是否正常配置
   - 确认网络连接状态
   - 查看控制台错误信息

2. **标签显示异常**
   - 清除浏览器缓存
   - 重启应用程序
   - 检查数据库完整性

3. **摘要内容不准确**
   - 手动编辑摘要内容
   - 调整生成参数
   - 提供反馈以改进AI模型

### 调试模式
开启开发者工具，查看控制台输出的调试信息：
- 摘要生成过程日志
- API调用状态
- 数据库操作结果

## 未来改进

### 计划功能
- 支持多语言摘要生成
- 摘要质量评分系统
- 批量摘要生成功能
- 摘要模板自定义
- 智能摘要推荐

### 性能优化
- 增量摘要更新
- 摘要压缩存储
- 分布式摘要生成
- 智能缓存策略

---

*本指南会随着功能更新持续完善，如有问题请及时反馈。*