/**
 * æ€§èƒ½å’Œå¯è®¿é—®æ€§ä¼˜åŒ– - Performance & Accessibility Optimizations
 * 
 * åŸºäºæŠ€æœ¯è´Ÿè´£äººå®¡æŸ¥çš„å…³é”®ä¼˜åŒ–ï¼š
 * 1. æ€§èƒ½ä¼˜åŒ– - å‡å°‘é‡ç»˜å’Œé‡æ’
 * 2. å¯è®¿é—®æ€§åˆè§„ - WCAG 2.1 AAæ ‡å‡†
 * 3. è‰²å½©å¯¹æ¯”åº¦ä¼˜åŒ–
 * 4. é”®ç›˜å¯¼èˆªæ”¯æŒ
 * 5. å±å¹•é˜…è¯»å™¨ä¼˜åŒ–
 */

/* ============== æ€§èƒ½ä¼˜åŒ–åŸºç¡€ ============== */

/* === GPUåŠ é€Ÿä¼˜åŒ– === */
.gpu-accelerated {
  will-change: transform, opacity !important;
  transform: translateZ(0) !important;
  backface-visibility: hidden !important;
}

/* ä¸ºå…³é”®åŠ¨ç”»å…ƒç´ å¯ç”¨GPUåŠ é€Ÿ */
.message-bubble,
.chat-item,
.input-container,
button,
.sidebar {
  @extend .gpu-accelerated;
}

/* === å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ– === */
.critical-content {
  /* ä¼˜å…ˆåŠ è½½å…³é”®å†…å®¹ */
  contain: layout style paint !important;
  content-visibility: auto !important;
  contain-intrinsic-size: auto 100px !important;
}

/* åº”ç”¨åˆ°ä¸»è¦å®¹å™¨ */
.messages-container,
.chat-list,
.input-area {
  @extend .critical-content;
}

/* === æ»šåŠ¨æ€§èƒ½ä¼˜åŒ– === */
.smooth-scroll {
  scroll-behavior: smooth !important;
  overflow-anchor: auto !important;
  overscroll-behavior: contain !important;
}

.messages-container {
  @extend .smooth-scroll;
}

/* === å›¾åƒå’Œåª’ä½“ä¼˜åŒ– === */
img, video {
  /* ç°ä»£å›¾åƒä¼˜åŒ– */
  content-visibility: auto !important;
  contain-intrinsic-size: 300px 200px !important;
  
  /* åŠ è½½ä¼˜åŒ– */
  loading: lazy !important;
  decoding: async !important;
}

/* ============== å¯è®¿é—®æ€§åŸºç¡€åˆè§„ ============== */

/* === WCAG 2.1 AA è‰²å½©å¯¹æ¯”åº¦ä¼˜åŒ– === */
:root {
  /* å¢å¼ºçš„å¯¹æ¯”åº¦è‰²å½© */
  --text-primary-high-contrast: 15 23 42;      /* æ·±åº¦ç¡®ä¿4.5:1å¯¹æ¯”åº¦ */
  --text-secondary-high-contrast: 51 65 85;    /* ä¸­ç­‰æ–‡æœ¬çš„é«˜å¯¹æ¯”åº¦ */
  --text-tertiary-high-contrast: 71 85 105;    /* è¾…åŠ©æ–‡æœ¬çš„å¯è¯»å¯¹æ¯”åº¦ */
  
  /* æŒ‰é’®å¯¹æ¯”åº¦ä¼˜åŒ– */
  --button-primary-contrast: 14 165 233;       /* ç¡®ä¿ä¸ç™½å­—çš„å¯¹æ¯”åº¦ */
  --button-secondary-contrast: 51 65 85;       /* æ¬¡è¦æŒ‰é’®çš„é«˜å¯¹æ¯”åº¦ */
  
  /* è¾¹æ¡†å¯¹æ¯”åº¦ */
  --border-high-contrast: 203 213 225;         /* æ›´æ˜æ˜¾çš„è¾¹æ¡† */
  --divider-high-contrast: 226 232 240;        /* åˆ†å‰²çº¿å¯è§æ€§ */
}

/* åº”ç”¨é«˜å¯¹æ¯”åº¦è‰²å½© */
.text-primary {
  color: hsl(var(--text-primary-high-contrast)) !important;
}

.text-secondary {
  color: hsl(var(--text-secondary-high-contrast)) !important;
}

.text-tertiary {
  color: hsl(var(--text-tertiary-high-contrast)) !important;
}

/* === ç„¦ç‚¹å¯è§æ€§å¢å¼º === */
:focus-visible {
  outline: 3px solid hsl(var(--primary-500)) !important;
  outline-offset: 2px !important;
  border-radius: 4px !important;
}

/* ç‰¹æ®Šå…ƒç´ çš„ç„¦ç‚¹æ ·å¼ */
button:focus-visible {
  outline: 3px solid hsl(var(--primary-500)) !important;
  outline-offset: 3px !important;
  box-shadow: 
    0 0 0 2px hsl(var(--background)),
    0 0 0 5px hsl(var(--primary-500) / 0.3) !important;
}

input:focus-visible, 
textarea:focus-visible, 
select:focus-visible {
  outline: 3px solid hsl(var(--primary-500)) !important;
  outline-offset: 1px !important;
}

/* === è·³è½¬å¯¼èˆªæ”¯æŒ === */
.skip-link {
  position: absolute !important;
  top: -40px !important;
  left: 16px !important;
  z-index: 9999 !important;
  
  background: hsl(var(--primary-500)) !important;
  color: white !important;
  padding: 8px 16px !important;
  border-radius: 4px !important;
  text-decoration: none !important;
  font-weight: 600 !important;
  
  transform: translateY(-100%) !important;
  transition: transform 0.2s ease !important;
}

.skip-link:focus {
  transform: translateY(0) !important;
  top: 16px !important;
}

/* ============== é”®ç›˜å¯¼èˆªä¼˜åŒ– ============== */

/* === Tabé¡ºåºä¼˜åŒ– === */
[tabindex="0"], 
[tabindex="-1"] {
  outline: none !important;
}

/* é”®ç›˜å¯¼èˆªæŒ‡ç¤ºå™¨ */
.keyboard-navigation-active *:focus-visible {
  outline: 3px solid hsl(var(--primary-500)) !important;
  outline-offset: 2px !important;
}

/* === é”®ç›˜å¿«æ·é”®æç¤º === */
.keyboard-shortcut {
  position: relative !important;
}

.keyboard-shortcut::after {
  content: attr(data-shortcut) !important;
  position: absolute !important;
  top: -30px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  
  background: hsl(var(--neutral-900)) !important;
  color: white !important;
  padding: 4px 8px !important;
  border-radius: 4px !important;
  font-size: 11px !important;
  font-weight: 500 !important;
  white-space: nowrap !important;
  
  opacity: 0 !important;
  pointer-events: none !important;
  transition: opacity 0.2s ease !important;
}

.keyboard-shortcut:hover::after,
.keyboard-shortcut:focus-visible::after {
  opacity: 1 !important;
}

/* ============== å±å¹•é˜…è¯»å™¨ä¼˜åŒ– ============== */

/* === å±å¹•é˜…è¯»å™¨ä¸“ç”¨æ–‡æœ¬ === */
.sr-only {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}

/* === ARIAæ ‡ç­¾å¢å¼º === */
[aria-label], 
[aria-labelledby], 
[aria-describedby] {
  /* ç¡®ä¿ARIAæ ‡ç­¾çš„å¯è®¿é—®æ€§ */
  position: relative !important;
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨çš„å±å¹•é˜…è¯»å™¨æ”¯æŒ */
[aria-live="polite"]::before {
  content: attr(aria-label) ": " !important;
  @extend .sr-only;
}

/* === å¯¹è¯æ¡†å¯è®¿é—®æ€§ === */
[role="dialog"] {
  /* æ¨¡æ€æ¡†ç„¦ç‚¹ç®¡ç† */
  isolation: isolate !important;
}

[role="dialog"]:focus {
  outline: none !important;
}

/* ============== è¿åŠ¨åå¥½æ”¯æŒ ============== */

/* === å‡å°‘åŠ¨ç”»åå¥½ === */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
  
  /* ä¿ç•™å…³é”®çš„çŠ¶æ€æŒ‡ç¤ºåŠ¨ç”» */
  .loading-spinner,
  .thinking-dots,
  .typing-indicator {
    animation-duration: 1s !important;
    animation-iteration-count: infinite !important;
  }
}

/* === é€æ˜åº¦åå¥½æ”¯æŒ === */
@media (prefers-reduced-transparency: reduce) {
  * {
    backdrop-filter: none !important;
    background: opaque !important;
  }
  
  .input-area,
  .chat-header,
  .sidebar {
    backdrop-filter: none !important;
    background: hsl(var(--surface-elevated)) !important;
  }
}

/* ============== é«˜å¯¹æ¯”åº¦æ¨¡å¼ ============== */

@media (prefers-contrast: high) {
  :root {
    /* æé«˜å¯¹æ¯”åº¦è‰²å½© */
    --text-primary: 0 0 0;           /* çº¯é»‘ */
    --text-secondary: 31 41 55;      /* æ·±ç° */
    --background: 255 255 255;       /* çº¯ç™½ */
    --border: 107 114 128;           /* ä¸­ç­‰ç° */
    --primary-500: 29 78 216;        /* é«˜å¯¹æ¯”åº¦è“ */
  }
  
  /* å¼ºåˆ¶è¾¹æ¡†å¯è§ */
  button, 
  input, 
  textarea, 
  .message-bubble,
  .chat-item {
    border: 2px solid hsl(var(--border)) !important;
  }
  
  /* ç§»é™¤é€æ˜åº¦ */
  * {
    background: opaque !important;
    backdrop-filter: none !important;
  }
  
  /* é«˜å¯¹æ¯”åº¦æ–‡æœ¬ */
  .text-primary,
  .text-secondary,
  .text-tertiary {
    font-weight: 600 !important;
    text-shadow: none !important;
  }
}

/* ============== å¼ºåˆ¶é¢œè‰²æ¨¡å¼ ============== */

@media (forced-colors: active) {
  /* ç³»ç»Ÿå¼ºåˆ¶é¢œè‰²æ¨¡å¼æ”¯æŒ */
  button {
    border: 2px solid ButtonText !important;
    background: ButtonFace !important;
    color: ButtonText !important;
  }
  
  button:hover {
    background: Highlight !important;
    color: HighlightText !important;
  }
  
  input, textarea {
    border: 2px solid ButtonText !important;
    background: Field !important;
    color: FieldText !important;
  }
  
  .message-bubble {
    border: 2px solid CanvasText !important;
    background: Canvas !important;
    color: CanvasText !important;
  }
}

/* ============== æ–‡æœ¬ç¼©æ”¾æ”¯æŒ ============== */

/* æ”¯æŒæœ€é«˜200%çš„æ–‡æœ¬ç¼©æ”¾ */
@media (min-resolution: 1.5dppx) {
  /* é«˜DPIè®¾å¤‡çš„æ–‡æœ¬ä¼˜åŒ– */
  body {
    text-rendering: optimizeLegibility !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
  }
}

/* === å¤§å­—ä½“æ”¯æŒ === */
@media (prefers-color-scheme: no-preference) {
  /* æ£€æµ‹ç³»ç»Ÿå­—ä½“å¤§å°è®¾ç½® */
  body {
    font-size: max(16px, 1rem) !important;
    line-height: max(1.5, 1.5rem) !important;
  }
  
  button {
    font-size: max(14px, 0.875rem) !important;
  }
  
  .chat-item h3 {
    font-size: max(14px, 0.875rem) !important;
  }
}

/* ============== é¢œè‰²ç›²æ”¯æŒ ============== */

/* ä½¿ç”¨å½¢çŠ¶å’Œå›¾æ ‡è€Œéä»…ä¾èµ–é¢œè‰² */
.status-success::before {
  content: "âœ“ " !important;
}

.status-error::before {
  content: "âœ— " !important;
}

.status-warning::before {
  content: "âš  " !important;
}

/* é“¾æ¥çš„éé¢œè‰²æ ‡è¯† */
a:not(.btn) {
  text-decoration: underline !important;
  text-underline-offset: 2px !important;
}

a:focus, a:hover {
  text-decoration: underline !important;
  text-decoration-thickness: 2px !important;
}

/* ============== è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– ============== */

@media (pointer: coarse) {
  /* è§¦æ‘¸è®¾å¤‡çš„æŒ‰é’®å°ºå¯¸è°ƒæ•´ */
  button, 
  [role="button"], 
  input, 
  textarea {
    min-height: 48px !important;
    min-width: 48px !important;
  }
  
  /* è§¦æ‘¸ç›®æ ‡é—´è· */
  .button-group button {
    margin: 4px !important;
  }
  
  /* è§¦æ‘¸åé¦ˆ */
  button:active {
    background: hsl(var(--surface-pressed)) !important;
    transform: scale(0.97) !important;
  }
}

/* ============== æ‰“å°æ ·å¼ä¼˜åŒ– ============== */

@media print {
  * {
    background: transparent !important;
    box-shadow: none !important;
    color: black !important;
    text-shadow: none !important;
  }
  
  .sidebar,
  .input-area,
  button {
    display: none !important;
  }
  
  .messages-container {
    width: 100% !important;
    max-width: none !important;
  }
  
  .message-bubble {
    break-inside: avoid !important;
    border: 1px solid black !important;
    margin: 8px 0 !important;
  }
}

/* ============== è°ƒè¯•å’Œå¼€å‘è¾…åŠ© ============== */

.development .accessibility-debug * {
  outline: 1px dashed blue !important;
}

.development .accessibility-debug [tabindex]:not([tabindex="-1"]) {
  outline: 2px solid green !important;
}

.development .accessibility-debug [aria-label]::after,
.development .accessibility-debug [aria-labelledby]::after {
  content: "ğŸ·ï¸" !important;
  position: absolute !important;
  right: 0 !important;
  top: 0 !important;
  font-size: 12px !important;
  z-index: 9999 !important;
}

/* ============== æ€§èƒ½ç›‘æ§ ============== */

/* æ ‡è®°æ€§èƒ½å…³é”®å…ƒç´  */
.perf-critical {
  contain: layout style paint !important;
}

/* å»¶è¿ŸåŠ è½½æ”¯æŒ */
.lazy-load {
  content-visibility: auto !important;
  contain-intrinsic-size: auto 200px !important;
}

/* è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ– */
.virtual-scroll-item {
  contain: strict !important;
  height: var(--item-height) !important;
}